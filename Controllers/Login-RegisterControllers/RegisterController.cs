using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using RecipeBlogProject.Models;
using RecipeProject.EmailService;
using RecipeProject.EmailService.Emails;

namespace RecipeBlogProject.Controllers
{
    public class RegisterController : Controller
    {
        private readonly ModelContext _context;
        private readonly IMailService mailService;

        public RegisterController(ModelContext context, IMailService mailService)
        {
            _context = context;
            this.mailService = mailService;
        }

        public IActionResult Register_Index()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> Register(Person person)
        {
            var checkPersonInfo = await _context.Systemusers.
                Where(X => X.Person.Email == person.Email && X.Person.Password == person.Password)
                .FirstOrDefaultAsync();


            if (checkPersonInfo == null)
            {
                if (ModelState.IsValid)
                {
                    person.RoleId = 3;
                    _context.Add(person);
                    await _context.SaveChangesAsync();
                    var personId = (await _context.Persons.FirstOrDefaultAsync(c=>c.Email == person.Email)).id;
                    
                    _context.Systemusers.Add(new()
                    {
                        PersonId = personId
                    });
                    await _context.SaveChangesAsync();
                }
            }
            var emailRequest = new MailRequest()
            {
                ToEmail = "person.Email",
                Subject ="Welcome to Recepie Blog",
                Body = "﻿<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html xmlns=\"http://www.w3.org/1999/xhtml\"\r\n      xmlns:v=\"urn:schemas-microsoft-com:vml\"\r\n      xmlns:o=\"urn:schemas-microsoft-com:office:office\">\r\n<head>\r\n    <!--[if gte mso 9]>\r\n      <xml>\r\n        <o:OfficeDocumentSettings>\r\n          <o:AllowPNG />\r\n          <o:PixelsPerInch>96</o:PixelsPerInch>\r\n        </o:OfficeDocumentSettings>\r\n      </xml>\r\n    <![endif]-->\r\n    <meta http-equiv=\"Content-type\" content=\"text/html; charset=utf-8\" />\r\n    <meta name=\"viewport\"\r\n          content=\"width=device-width, initial-scale=1, maximum-scale=1\" />\r\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\r\n    <meta name=\"format-detection\" content=\"date=no\" />\r\n    <meta name=\"format-detection\" content=\"address=no\" />\r\n    <meta name=\"format-detection\" content=\"telephone=no\" />\r\n    <meta name=\"x-apple-disable-message-reformatting\" />\r\n    <!--[if !mso]><!-->\r\n    <link href=\"https://fonts.googleapis.com/css?family=Muli:400,400i,700,700i\"\r\n          rel=\"stylesheet\" />\r\n    <!--<![endif]-->\r\n    <title>Welcome</title>\r\n    <!--[if gte mso 9]>\r\n      <style type=\"text/css\" media=\"all\">\r\n        sup {\r\n          font-size: 100% !important;\r\n        }\r\n      </style>\r\n    <![endif]-->\r\n\r\n    <style type=\"text/css\" media=\"screen\">\r\n        /* Linked Styles */\r\n        body {\r\n            padding: 0 !important;\r\n            margin: 0 !important;\r\n            display: block !important;\r\n            min-width: 100% !important;\r\n            width: 100% !important;\r\n            background: white;\r\n            -webkit-text-size-adjust: none;\r\n        }\r\n\r\n        a {\r\n            color: #66c7ff;\r\n            text-decoration: none;\r\n        }\r\n\r\n        p {\r\n            padding: 0 !important;\r\n            margin: 0 !important;\r\n        }\r\n\r\n        img {\r\n            -ms-interpolation-mode: bicubic; /* Allow smoother rendering of resized image in Internet Explorer */\r\n        }\r\n\r\n        .mcnPreviewText {\r\n            display: none !important;\r\n        }\r\n\r\n        /* Mobile styles */\r\n        @media only screen and (max-device-width: 480px), only screen and (max-width: 480px) {\r\n            .mobile-shell {\r\n                width: 100% !important;\r\n                min-width: 100% !important;\r\n            }\r\n\r\n            .bg {\r\n                background-size: 100% auto !important;\r\n                -webkit-background-size: 100% auto !important;\r\n            }\r\n\r\n            .text-header,\r\n            .m-center {\r\n                text-align: center !important;\r\n            }\r\n\r\n            .center {\r\n                margin: 0 auto !important;\r\n            }\r\n\r\n            .container {\r\n                padding: 20px 10px !important;\r\n            }\r\n\r\n            .td {\r\n                width: 100% !important;\r\n                min-width: 100% !important;\r\n            }\r\n\r\n            .m-br-15 {\r\n                height: 15px !important;\r\n            }\r\n\r\n            .p30-15 {\r\n                padding: 30px 15px !important;\r\n            }\r\n\r\n            .m-td,\r\n            .m-hide {\r\n                display: none !important;\r\n                width: 0 !important;\r\n                height: 0 !important;\r\n                font-size: 0 !important;\r\n                line-height: 0 !important;\r\n                min-height: 0 !important;\r\n            }\r\n\r\n            .m-block {\r\n                display: block !important;\r\n            }\r\n\r\n            .fluid-img img {\r\n                width: 100% !important;\r\n                max-width: 100% !important;\r\n                height: auto !important;\r\n            }\r\n\r\n            .column,\r\n            .column-top,\r\n            .column-empty,\r\n            .column-empty2,\r\n            .column-dir-top {\r\n                float: left !important;\r\n                width: 100% !important;\r\n                display: block !important;\r\n            }\r\n\r\n            .column-empty {\r\n                padding-bottom: 10px !important;\r\n            }\r\n\r\n            .column-empty2 {\r\n                padding-bottom: 30px !important;\r\n            }\r\n\r\n            .content-spacing {\r\n                width: 15px !important;\r\n            }\r\n        }\r\n    </style>\r\n</head>\r\n<body class=\"body\"\r\n      style=\"\r\n      padding: 0 !important;\r\n      margin: 0 !important;\r\n      display: block !important;\r\n      min-width: 100% !important;\r\n      width: 100% !important;\r\n      background: white;\r\n      -webkit-text-size-adjust: none;\r\n    \">\r\n    <table width=\"100%\"\r\n           border=\"0\"\r\n           cellspacing=\"0\"\r\n           cellpadding=\"0\"\r\n           style=\"background-color: white;\">\r\n        <tr>\r\n            <td align=\"center\" valign=\"top\">\r\n                <table width=\"650\"\r\n                       border=\"0\"\r\n                       cellspacing=\"0\"\r\n                       cellpadding=\"0\"\r\n                       class=\"mobile-shell\">\r\n                    <tr>\r\n                        <td class=\"td container\"\r\n                            style=\"\r\n                  width: 650px;\r\n                  min-width: 650px;\r\n                  font-size: 0pt;\r\n                  line-height: 0pt;\r\n                  margin: 0;\r\n                  font-weight: normal;\r\n                  padding: 55px 0px;\r\n                \">\r\n                            <!-- Header -->\r\n                            <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\r\n                                <tr>\r\n                                    <td class=\"p30-15\" style=\"padding: 0px 30px 30px 30px;\">\r\n                                        <table width=\"100%\"\r\n                                               border=\"0\"\r\n                                               cellspacing=\"0\"\r\n                                               cellpadding=\"0\">\r\n                                            <tr>\r\n                                                <th class=\"column-top\"\r\n                                                    width=\"145\"\r\n                                                    style=\"\r\n                              font-size: 0pt;\r\n                              line-height: 0pt;\r\n                              padding: 0;\r\n                              margin: 0;\r\n                              font-weight: normal;\r\n                              vertical-align: top;\r\n                            \">\r\n                                                    <table width=\"100%\"\r\n                                                           border=\"0\"\r\n                                                           cellspacing=\"0\"\r\n                                                           cellpadding=\"0\">\r\n                                                        <tr>\r\n                                                            <td class=\"img m-center\"\r\n                                                                style=\"\r\n                                    font-size: 0pt;\r\n                                    line-height: 0pt;\r\n                                    text-align: center;\r\n                                  \">\r\n                                                                <img src=\"[ImgLink]\"\r\n                                                                     width=\"150\"\r\n                                                                     height=\"50\"\r\n                                                                     border=\"0\"\r\n                                                                     alt=\"\" />\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </th>\r\n                                                <th class=\"column-empty\"\r\n                                                    width=\"1\"\r\n                                                    style=\"\r\n                              font-size: 0pt;\r\n                              line-height: 0pt;\r\n                              padding: 0;\r\n                              margin: 0;\r\n                              font-weight: normal;\r\n                              vertical-align: top;\r\n                            \"></th>\r\n                                                <th class=\"column\"\r\n                                                    style=\"\r\n                              font-size: 0pt;\r\n                              line-height: 0pt;\r\n                              padding: 0;\r\n                              margin: 0;\r\n                              font-weight: normal;\r\n                            \">\r\n                                                    <table width=\"100%\"\r\n                                                           border=\"0\"\r\n                                                           cellspacing=\"0\"\r\n                                                           cellpadding=\"0\">\r\n                                                        <tr>\r\n                                                            <td class=\"text-header\"\r\n                                                                style=\"\r\n                                    color: #475c77;\r\n                                    font-family: 'Muli', Arial, sans-serif;\r\n                                    font-size: 12px;\r\n                                    line-height: 16px;\r\n                                    text-align: right;\r\n                                  \">\r\n                                                                <a href=\"#\"\r\n                                                                   target=\"_blank\"\r\n                                                                   class=\"link2\"\r\n                                                                   style=\"\r\n                                      color: #475c77;\r\n                                      text-decoration: none;\r\n                                    \">\r\n                                                                    <span class=\"link2\"\r\n                                                                          style=\"\r\n                                        color: #475c77;\r\n                                        text-decoration: none;\r\n                                      \"></span>\r\n                                                                </a>\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                    </table>\r\n                                                </th>\r\n                                            </tr>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </table>\r\n                            <!-- END Header -->\r\n                            <!-- Intro -->\r\n                            <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\r\n                                <tr>\r\n                                    <td style=\"padding-bottom: 10px;\">\r\n                                        <table width=\"100%\"\r\n                                               border=\"0\"\r\n                                               cellspacing=\"0\"\r\n                                               cellpadding=\"0\">\r\n                                            <tr>\r\n                                                <td class=\"tbrr p30-15\"\r\n                                                    style=\"\r\n                              padding: 60px 30px;\r\n                              border-radius: 26px 26px 0px 0px;\r\n                            \"\r\n                                                    bgcolor=\"#12325c\">\r\n                                                    <table width=\"100%\"\r\n                                                           border=\"0\"\r\n                                                           cellspacing=\"0\"\r\n                                                           cellpadding=\"0\">\r\n                                                        <tr>\r\n                                                            <td class=\"h1 pb25\"\r\n                                                                style=\"\r\n                                    color: #ffffff;\r\n                                    font-family: 'Muli', Arial, sans-serif;\r\n                                    font-size: 40px;\r\n                                    line-height: 46px;\r\n                                    text-align: center;\r\n                                    padding-bottom: 25px;\r\n                                  \">\r\n                                                                Welcome, [username]\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                        <tr>\r\n                                                            <td class=\"text-center pb25\"\r\n                                                                style=\"\r\n                                    color: #c1cddc;\r\n                                    font-family: 'Muli', Arial, sans-serif;\r\n                                    font-size: 16px;\r\n                                    line-height: 30px;\r\n                                    text-align: center;\r\n                                    padding-bottom: 25px;\r\n                                  \">\r\n                                                                You are currently registered using\r\n                                                                <span class=\"m-hide\"><br /></span>[email]\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                        <!-- Button -->\r\n                                                        <tr>\r\n                                                            <td align=\"center\">\r\n                                                                <table class=\"center\"\r\n                                                                       border=\"0\"\r\n                                                                       cellspacing=\"0\"\r\n                                                                       cellpadding=\"0\"\r\n                                                                       style=\"text-align: center;\">\r\n                                                                    <tr>\r\n                                                                        <td class=\"pink-button text-button\"\r\n                                                                            style=\"\r\n                                          background: #ff6666;\r\n                                          color: #c1cddc;\r\n                                          font-family: 'Muli', Arial, sans-serif;\r\n                                          font-size: 14px;\r\n                                          line-height: 18px;\r\n                                          padding: 12px 30px;\r\n                                          text-align: center;\r\n                                          border-radius: 0px 22px 22px 22px;\r\n                                          font-weight: bold;\r\n                                        \">\r\n                                                                            <a href=\"[Link]\"\r\n                                                                               target=\"_blank\"\r\n                                                                               class=\"link-white\"\r\n                                                                               style=\"\r\n                                            color: #ffffff;\r\n                                            text-decoration: none;\r\n                                          \">\r\n                                                                                <span class=\"link-white\"\r\n                                                                                      style=\"\r\n                                              color: #ffffff;\r\n                                              text-decoration: none;\r\n                                            \">CLICK HERE</span>\r\n                                                                            </a>\r\n                                                                        </td>\r\n                                                                    </tr>\r\n                                                                </table>\r\n                                                            </td>\r\n                                                        </tr>\r\n                                                        <!-- END Button -->\r\n                                                    </table>\r\n                                                </td>\r\n                                            </tr>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </table>\r\n                        </td>\r\n                    </tr>\r\n                </table>\r\n            </td>\r\n        </tr>\r\n    </table>\r\n</body>\r\n</html>"

            };
           emailRequest.Body =  emailRequest.Body
                                            .Replace("[username]", person.Firstname + " "+ person.Lastname)
                                            .Replace("[email]", person.Email)
                                            .Replace("[Link]", "https://localhost:7265/")
                                            .Replace("[ImgLink]", "https://images.pexels.com/photos/1860208/pexels-photo-1860208.jpeg?cs=srgb&dl=cooked-food-1860208.jpg&fm=jpg");
            try
            {
                await mailService.SendEmailAsync(emailRequest);
                return RedirectToAction("Index", "Home");
            }
            catch (Exception ex)
            {
                throw;
            }

            return RedirectToAction("Index", "Home");
        }

        public IActionResult ChefRegisterIndex()
        {
            return View();
        }

        [HttpPost]
        public async Task<IActionResult> ChefRegister(Person person)
        {
            var checkPersonInfo = await _context.Systemusers.
                Where(X => X.Person.Email == person.Email && X.Person.Password == person.Password)
                .FirstOrDefaultAsync();


            if (checkPersonInfo == null)
            {
                if (ModelState.IsValid)
                {
                    person.RoleId = 2;
                    person.IsDeleted = true;
                    _context.Persons.Add(person);
                    await _context.SaveChangesAsync();

                    var chef = new Chef()
                    {
                        PersonId = person.id,
                        IsDeleted = true,
                    };
                    _context.Chefs.Add(chef);
                    await _context.SaveChangesAsync();
                }
            }

            return RedirectToAction("Index", "Home");
        }
    }
}
